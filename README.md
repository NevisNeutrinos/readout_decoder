# readout_decoder

To install the decoder you need:
* cmake >= 3.30
* C++17 or newer
* python >= 3.10
* scikit-build

Then git clone the package to your desire location. Then to include 
`pybind11` for the python bindings, from the root directory run

```
git submodule init && git submodule update
```

Then build the decoder with,

```
cd extern
pip install .
```
If you want to uninstall the bindings run,

```
pip uninstall decoder_bindings
```

Then the decoder can be used from python such as pandas

```python
import decoder_bindings
import pandas
import copy

process = decoder_bindings.ProcessEvents()

test_file = "/path/to/file/pGRAMS_bin_X.dat"
process.open_file(test_file)

# Iterate through file, one event at a time
# it will return True until the last event is processed
# in which case it will return False
event_num = 0
event_dict = {}
while process.get_event():
    event_dict[event_num] = copy.deepcopy(process.get_event_dict())
    print(event_num)
    event_num += 1

df = pandas.DataFrame(event_dict).T
```
Each row is an event with `Charge` and `Light` columns,
```python
Event	Light	Charge
0	{16: {'slot_number': 16, 'num_adc_word': 121, ...	{0: {'slot_number': 0, 'num_adc_word': 0, 'eve...
1	{16: {'slot_number': 16, 'num_adc_word': 121, ...	{0: {'slot_number': 0, 'num_adc_word': 0, 'eve...
2	{16: {'slot_number': 16, 'num_adc_word': 121, ...	{0: {'slot_number': 0, 'num_adc_word': 0, 'eve...
3	{16: {'slot_number': 16, 'num_adc_word': 121, ...	{0: {'slot_number': 0, 'num_adc_word': 0, 'eve...
4	{16: {'slot_number': 16, 'num_adc_word': 121, ...	{0: {'slot_number': 0, 'num_adc_word': 0, 'eve...
```
and each event is a dictionary of the data. For the charge FEMs we have, 
(the event number is +1 to the real event number) 

```python
>>> event = 5
>>> fem_number = 15
>>> df['Charge'][event][fem_number]


{'slot_number': 15,
 'num_adc_word': 38207,
 'event_number': 6,
 'event_frame_number': 5931,
 'trigger_frame_number': 5923,
 'check_sum': 7751783,
 'trigger_sample': 94,
 'channel': array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
                    17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33,
                    34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50,
                    51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63], dtype=uint16),
 'adc_words': array([[2045, 2044, 2045, ..., 2045, 2045, 2045],
                     [2050, 2050, 2050, ..., 2050, 2050, 2050],
                     [2045, 2045, 2044, ..., 2045, 2044, 2045],
                     ...,
                     [   0,    0,    0, ...,    0,    0,    0],
                     [   0,    0,    0, ...,    0,    0,    0],
                     [   0,    0,    0, ...,    0,    0,    0]],
                    shape=(64, 595), dtype=uint16)}
```

The light FEM has this data format. The `_reco` suffix is the light waveform that
has been reconstructed from the individual ROIs within the event.

```python
>>> event = 5
>>> fem_number = 16
>>> df['Light'][event][fem_number]


{'slot_number': 16,
 'num_adc_word': 961,
 'event_number': 5,
 'event_frame_number': 5932,
 'trigger_frame_number': 5924,
 'check_sum': 7790492,
 'trigger_sample': 94,
 'channel': array([2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
                   2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2], dtype=uint16),
 'light_frame_number': array([19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 20, 20, 20, 20, 20, 20, 20,
                              20, 20, 20, 21, 21, 21, 21, 21, 21, 21, 21, 21, 21, 22, 22, 22, 22,
                              22, 22, 22, 22, 22, 22], dtype=uint16),
 'light_readout_sample': array([ 266,  906, 1546, 2186, 2826, 3466, 4106, 4746, 5386, 6026,  266,
                                 906, 1546, 2186, 2826, 3466, 4106, 4746, 5386, 6026,  266,  906,
                                 1546, 2186, 2826, 3466, 4106, 4746, 5386, 6026,  266,  906, 1546,
                                 2186, 2826, 3466, 4106, 4746, 5386, 6026], dtype=uint16),
 'adc_words': array([[2040, 2048, 2307, 2636, 2817, 2834, 2747, 2615, 2480, 2362, 2266,
                      2197, 2145, 2109, 2085, 2069, 2059, 2052, 2047, 2045],
                     [2042, 2048, 2310, 2637, 2817, 2834, 2747, 2613, 2480, 2361, 2268,
                      2196, 2145, 2110, 2086, 2069, 2060, 2053, 2048, 2046],
                     [2041, 2048, 2308, 2637, 2816, 2834, 2747, 2615, 2480, 2362, 2267,
                      2197, 2146, 2110, 2085, 2068, 2059, 2052, 2048, 2044],
                     [2041, 2049, 2309, 2639, 2818, 2837, 2749, 2617, 2481, 2362, 2266,
                      2195, 2143, 2109, 2085, 2068, 2059, 2052, 2048, 2044],
                     [2041, 2049, 2313, 2640, 2819, 2835, 2747, 2615, 2479, 2361, 2266,
                      2195, 2145, 2109, 2084, 2069, 2058, 2052, 2047, 2044],
                     [2040, 2049, 2313, 2641, 2818, 2834, 2744, 2613, 2478, 2359, 2265,
                      2194, 2144, 2108, 2086, 2070, 2059, 2051, 2048, 2044],
                     [2040, 2049, 2311, 2639, 2817, 2833, 2746, 2613, 2479, 2361, 2267,
                      2195, 2145, 2110, 2085, 2069, 2059, 2052, 2049, 2046],
                     [2041, 2051, 2317, 2644, 2819, 2833, 2744, 2612, 2476, 2359, 2265,
                      2195, 2143, 2109, 2084, 2068, 2058, 2052, 2047, 2044],
                     [2040, 2051, 2316, 2643, 2819, 2833, 2743, 2612, 2477, 2359, 2266,
                      2195, 2144, 2109, 2086, 2069, 2058, 2052, 2047, 2044],
                     [2042, 2052, 2319, 2645, 2821, 2833, 2743, 2610, 2475, 2357, 2265,
                      2194, 2144, 2108, 2084, 2068, 2057, 2052, 2047, 2045],
                     [2040, 2051, 2320, 2644, 2820, 2833, 2744, 2611, 2477, 2359, 2265,
                      2195, 2142, 2110, 2085, 2069, 2059, 2053, 2047, 2044],
                     [2041, 2053, 2325, 2650, 2823, 2834, 2743, 2609, 2475, 2357, 2263,
                      2193, 2143, 2108, 2084, 2067, 2058, 2052, 2048, 2044],
                     [2041, 2054, 2327, 2652, 2824, 2833, 2742, 2608, 2473, 2356, 2263,
                      2192, 2142, 2108, 2084, 2068, 2057, 2051, 2047, 2044],
                     [2040, 2056, 2330, 2654, 2822, 2832, 2740, 2607, 2472, 2355, 2262,
                      2192, 2142, 2107, 2083, 2067, 2057, 2051, 2047, 2044],
                     [2041, 2053, 2326, 2651, 2820, 2831, 2740, 2607, 2474, 2355, 2263,
                      2192, 2143, 2108, 2084, 2068, 2059, 2051, 2047, 2045],
                     [2042, 2056, 2332, 2653, 2822, 2830, 2737, 2605, 2469, 2352, 2261,
                      2191, 2142, 2107, 2082, 2066, 2057, 2051, 2047, 2045],
                     [2042, 2056, 2333, 2656, 2823, 2832, 2739, 2605, 2472, 2355, 2261,
                      2190, 2141, 2107, 2083, 2066, 2057, 2051, 2046, 2044],
                     [2041, 2056, 2336, 2657, 2824, 2831, 2739, 2606, 2470, 2354, 2259,
                      2191, 2142, 2107, 2084, 2068, 2058, 2052, 2047, 2045],
                     [2041, 2056, 2333, 2656, 2824, 2831, 2739, 2607, 2471, 2355, 2262,
                      2191, 2143, 2108, 2084, 2068, 2059, 2052, 2048, 2044],
                     [2041, 2057, 2336, 2657, 2824, 2831, 2739, 2605, 2472, 2354, 2261,
                      2191, 2142, 2108, 2084, 2068, 2058, 2052, 2048, 2044],
                     [2042, 2058, 2342, 2662, 2826, 2830, 2736, 2603, 2468, 2351, 2259,
                      2191, 2140, 2107, 2083, 2067, 2057, 2051, 2046, 2043],
                     [2041, 2058, 2340, 2660, 2825, 2830, 2738, 2603, 2470, 2354, 2260,
                      2191, 2142, 2107, 2084, 2067, 2059, 2052, 2048, 2044],
                     [2042, 2060, 2344, 2663, 2827, 2830, 2735, 2601, 2466, 2352, 2258,
                      2190, 2141, 2104, 2083, 2067, 2057, 2051, 2047, 2044],
                     [2041, 2060, 2345, 2663, 2825, 2829, 2734, 2600, 2465, 2350, 2258,
                      2190, 2140, 2105, 2083, 2068, 2058, 2052, 2047, 2045],
                     [2042, 2062, 2348, 2666, 2826, 2829, 2735, 2600, 2467, 2351, 2258,
                      2190, 2141, 2106, 2083, 2067, 2057, 2051, 2047, 2044],
                     [2042, 2063, 2348, 2666, 2828, 2830, 2733, 2600, 2466, 2350, 2257,
                      2189, 2141, 2105, 2082, 2067, 2057, 2051, 2046, 2044],
                     [2042, 2062, 2350, 2668, 2827, 2828, 2732, 2599, 2465, 2349, 2258,
                      2189, 2140, 2106, 2083, 2067, 2057, 2051, 2048, 2044],
                     [2041, 2062, 2350, 2668, 2828, 2829, 2733, 2600, 2465, 2350, 2257,
                      2189, 2139, 2105, 2083, 2067, 2058, 2052, 2046, 2043],
                     [2041, 2063, 2353, 2670, 2828, 2828, 2733, 2598, 2462, 2349, 2256,
                      2188, 2141, 2105, 2082, 2068, 2057, 2051, 2047, 2043],
                     [2041, 2063, 2352, 2668, 2827, 2828, 2732, 2599, 2465, 2351, 2258,
                      2190, 2141, 2106, 2082, 2069, 2059, 2052, 2048, 2045],
                     [2041, 2063, 2353, 2670, 2829, 2828, 2733, 2598, 2465, 2349, 2258,
                      2190, 2140, 2106, 2083, 2068, 2060, 2052, 2047, 2046],
                     [2041, 2065, 2358, 2673, 2828, 2827, 2730, 2597, 2463, 2347, 2256,
                      2189, 2139, 2106, 2082, 2067, 2057, 2051, 2047, 2044],
                     [2040, 2065, 2356, 2672, 2829, 2828, 2732, 2597, 2464, 2348, 2256,
                      2188, 2140, 2106, 2082, 2068, 2058, 2052, 2048, 2045],
                     [2041, 2067, 2362, 2674, 2830, 2827, 2729, 2596, 2462, 2346, 2255,
                      2187, 2138, 2104, 2081, 2066, 2056, 2050, 2046, 2043],
                     [2041, 2065, 2360, 2674, 2830, 2828, 2730, 2596, 2462, 2347, 2257,
                      2188, 2138, 2106, 2082, 2066, 2057, 2050, 2046, 2043],
                     [2039, 2067, 2363, 2677, 2829, 2826, 2728, 2593, 2459, 2346, 2255,
                      2186, 2139, 2104, 2082, 2067, 2057, 2051, 2047, 2044],
                     [2042, 2069, 2368, 2682, 2831, 2826, 2727, 2593, 2460, 2344, 2254,
                      2187, 2138, 2105, 2081, 2066, 2057, 2051, 2047, 2044],
                     [2039, 2067, 2366, 2677, 2829, 2826, 2728, 2592, 2461, 2345, 2253,
                      2186, 2138, 2105, 2083, 2067, 2057, 2051, 2047, 2046],
                     [2041, 2071, 2372, 2683, 2832, 2825, 2725, 2590, 2457, 2343, 2252,
                      2184, 2137, 2104, 2081, 2065, 2056, 2048, 2046, 2043],
                     [2042, 2072, 2373, 2683, 2830, 2824, 2724, 2590, 2457, 2342, 2253,
                      2183, 2135, 2103, 2081, 2066, 2057, 2051, 2047, 2044]],
                    dtype=uint16),
 'adc_words_reco': array([[2048, 2048, 2048, ..., 2048, 2048, 2048],
                          [2048, 2048, 2048, ..., 2048, 2048, 2048],
                          [2048, 2048, 2048, ..., 2048, 2048, 2048],
                          ...,
                          [2048, 2048, 2048, ..., 2048, 2048, 2048],
                          [2048, 2048, 2048, ..., 2048, 2048, 2048],
                          [2048, 2048, 2048, ..., 2048, 2048, 2048]],
                         shape=(32, 81600), dtype=uint16),
 'adc_axis_reco': array([-464640.625, -464625.   , -464609.375, ...,  810312.5  ,
                         810328.125,  810343.75 ], shape=(81600,))}

```